<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nostr-arena Web Example</title>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        h1 {
            color: #7c3aed;
        }
        .panel {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #6d28d9;
        }
        button:disabled {
            background: #4a4a6a;
            cursor: not-allowed;
        }
        input {
            background: #0f0f23;
            border: 1px solid #333;
            color: #eee;
            padding: 10px;
            border-radius: 6px;
            margin-right: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .status.connected {
            background: #166534;
        }
        .status.disconnected {
            background: #991b1b;
        }
        .players {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .player {
            background: #1e1e3f;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        .player.ready {
            border: 2px solid #22c55e;
        }
        .events {
            max-height: 300px;
            overflow-y: auto;
            background: #0f0f23;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
        }
        .event {
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }
    </style>
</head>
<body>
    <h1>nostr-arena Web Example</h1>

    <div class="panel">
        <h2>Connection</h2>
        <button id="connect-btn">Connect</button>
        <button id="disconnect-btn" disabled>Disconnect</button>
        <div id="status" class="status disconnected">Disconnected</div>
    </div>

    <div class="panel">
        <h2>Room</h2>
        <button id="create-btn" disabled>Create Room</button>
        <input type="text" id="room-id" placeholder="Room ID">
        <button id="join-btn" disabled>Join Room</button>
        <button id="leave-btn" disabled>Leave Room</button>
        <div id="room-url" style="margin-top: 10px; word-break: break-all;"></div>
    </div>

    <div class="panel">
        <h2>Game</h2>
        <button id="ready-btn" disabled>Ready</button>
        <button id="start-btn" disabled>Start Game (Host)</button>
        <input type="text" id="message" placeholder="Message">
        <button id="send-btn" disabled>Send State</button>
    </div>

    <div class="panel">
        <h2>Players</h2>
        <div id="players" class="players"></div>
    </div>

    <div class="panel">
        <h2>Events</h2>
        <div id="events" class="events"></div>
    </div>

    <script type="module">
        import init, { Arena, ArenaConfig } from './pkg/nostr_arena_wasm.js';

        let arena = null;
        let isReady = false;
        let pollInterval = null;

        async function main() {
            await init();

            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const createBtn = document.getElementById('create-btn');
            const joinBtn = document.getElementById('join-btn');
            const leaveBtn = document.getElementById('leave-btn');
            const readyBtn = document.getElementById('ready-btn');
            const startBtn = document.getElementById('start-btn');
            const sendBtn = document.getElementById('send-btn');
            const roomIdInput = document.getElementById('room-id');
            const messageInput = document.getElementById('message');
            const statusDiv = document.getElementById('status');
            const roomUrlDiv = document.getElementById('room-url');
            const playersDiv = document.getElementById('players');
            const eventsDiv = document.getElementById('events');

            function logEvent(msg) {
                const div = document.createElement('div');
                div.className = 'event';
                div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                eventsDiv.prepend(div);
            }

            function updatePlayers(players) {
                playersDiv.innerHTML = players.map(p => `
                    <div class="player ${p.ready ? 'ready' : ''}">
                        <div>${p.pubkey.slice(0, 8)}...</div>
                        <div>${p.ready ? 'âœ“ Ready' : 'Not ready'}</div>
                    </div>
                `).join('');
            }

            async function pollEvents() {
                if (!arena) return;

                try {
                    const event = await arena.tryRecv();
                    if (event) {
                        logEvent(`${event.type}: ${JSON.stringify(event)}`);

                        if (event.type === 'playerJoin' || event.type === 'playerLeave') {
                            const players = await arena.players();
                            updatePlayers(players);
                        }
                    }
                } catch (e) {
                    console.error('Poll error:', e);
                }
            }

            connectBtn.onclick = async () => {
                try {
                    const config = new ArenaConfig('web-example')
                        .setMaxPlayers(4)
                        .setStartMode('ready')
                        .setBaseUrl(window.location.origin);

                    arena = await Arena.init(config);
                    await arena.connect();

                    statusDiv.textContent = `Connected: ${arena.publicKey().slice(0, 16)}...`;
                    statusDiv.className = 'status connected';

                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    createBtn.disabled = false;
                    joinBtn.disabled = false;

                    pollInterval = setInterval(pollEvents, 100);

                    logEvent('Connected to relays');
                } catch (e) {
                    logEvent(`Connection error: ${e}`);
                }
            };

            disconnectBtn.onclick = async () => {
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }

                if (arena) {
                    await arena.disconnect();
                    arena = null;
                }

                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'status disconnected';

                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                createBtn.disabled = true;
                joinBtn.disabled = true;
                leaveBtn.disabled = true;
                readyBtn.disabled = true;
                startBtn.disabled = true;
                sendBtn.disabled = true;

                playersDiv.innerHTML = '';
                roomUrlDiv.textContent = '';

                logEvent('Disconnected');
            };

            createBtn.onclick = async () => {
                try {
                    const url = await arena.create();
                    roomUrlDiv.textContent = `Room URL: ${url}`;

                    createBtn.disabled = true;
                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                    readyBtn.disabled = false;
                    startBtn.disabled = false;
                    sendBtn.disabled = false;

                    const players = await arena.players();
                    updatePlayers(players);

                    logEvent(`Room created: ${url}`);
                } catch (e) {
                    logEvent(`Create error: ${e}`);
                }
            };

            joinBtn.onclick = async () => {
                const roomId = roomIdInput.value.trim();
                if (!roomId) {
                    logEvent('Please enter a room ID');
                    return;
                }

                try {
                    await arena.join(roomId);

                    createBtn.disabled = true;
                    joinBtn.disabled = true;
                    leaveBtn.disabled = false;
                    readyBtn.disabled = false;
                    sendBtn.disabled = false;

                    const players = await arena.players();
                    updatePlayers(players);

                    logEvent(`Joined room: ${roomId}`);
                } catch (e) {
                    logEvent(`Join error: ${e}`);
                }
            };

            leaveBtn.onclick = async () => {
                try {
                    await arena.leave();

                    createBtn.disabled = false;
                    joinBtn.disabled = false;
                    leaveBtn.disabled = true;
                    readyBtn.disabled = true;
                    startBtn.disabled = true;
                    sendBtn.disabled = true;

                    playersDiv.innerHTML = '';
                    roomUrlDiv.textContent = '';
                    isReady = false;
                    readyBtn.textContent = 'Ready';

                    logEvent('Left room');
                } catch (e) {
                    logEvent(`Leave error: ${e}`);
                }
            };

            readyBtn.onclick = async () => {
                try {
                    isReady = !isReady;
                    await arena.sendReady(isReady);
                    readyBtn.textContent = isReady ? 'Not Ready' : 'Ready';

                    const players = await arena.players();
                    updatePlayers(players);

                    logEvent(`Ready: ${isReady}`);
                } catch (e) {
                    logEvent(`Ready error: ${e}`);
                }
            };

            startBtn.onclick = async () => {
                try {
                    await arena.startGame();
                    logEvent('Game started');
                } catch (e) {
                    logEvent(`Start error: ${e}`);
                }
            };

            sendBtn.onclick = async () => {
                const message = messageInput.value.trim();
                try {
                    await arena.sendState({ message, timestamp: Date.now() });
                    messageInput.value = '';
                    logEvent(`State sent: ${message}`);
                } catch (e) {
                    logEvent(`Send error: ${e}`);
                }
            };
        }

        main().catch(console.error);
    </script>
</body>
</html>
